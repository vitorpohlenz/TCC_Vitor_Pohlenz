---
title: "ExeploPDDE"
author: "Vitor Pohlenz"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r data}
vmax = 100
v1 = 55
qmax = 100
pho = 1

L=80

y =  list(y1=5,
          y2 = c(0,60),
          y3 = c(35,50)
          )
termicas = data.frame(nome = as.factor(1:3),
                      ca = c(1,2,5),
                      cl = 0,
                      liminf = 0,
                      limsup = c(30,20,Inf)
                      )

volumes = c(v1,NA[2:4])
q = rep(0,3)
a2 = data.frame(nome = "H", ca = 0, cl = 0 , liminf = 0, limsup =vmax)
a3 = data.frame(nome = "H", ca = 0, cl = 0 , liminf = 0, limsup =vmax)

# ordem de despacho
ode = list(ode1 = rbind(termicas,a2[,1:ncol(termicas)]),
           ode2 = rbind(termicas,a3[,1:ncol(termicas)]),
           ode3 = rbind(data.frame(nome = "H", ca = 0, cl = 0 , 
                                   liminf = 0, limsup =vmax),
                        termicas)
           )

# geracao
gera = data.frame(p1 = 0, p2 = 0, p3 = 0, gh = 0)

cust = rep(0,3)

# variaveis para somar vazao e volume no mesmo estagio
vt = 0
qt = 0
gh = 0
pot = 0
```

```{r foward}
# foward
for (t in 1:3) {
  gh = 0
  vt = 0
  qt = 0
  pot = 0
  ode[[t]] = ode[[t]][order(abs(ode[[t]]$ca)),] # Ordem de despacho por merito
  A = sample(y[[t]],size = 1)+volumes[t] # Agua disponivel para usar
  A0 = A #Agua disponivel para usar no inicio do estagio de tempo
  gera[t,] = 0 #Limpando geracao do foward anterior
  
  for (k in 1:length(ode[[t]]$nome)){
    
    if((ode[[t]][k,"nome"] == "H")&(A >= ode[[t]][k,"liminf"])){ # Agua com valor zero
      volumes[t+1] = min(max(A-(L-pot)/pho, ode[[t]][k,"liminf"]),
                         vmax) # v_t+1 com valor para agua custo zero ou que supre a carga, mas menor que vmax
      q[t] =  min(c(qt + A - volumes[t+1], qmax)) # Quanto pode turbinar para deixar volume
      volumes[t+1] = min(A0-q[t],vmax) #caso qmax seja atingido mas pot nao supra L, garantindo que nao tenha perca de agua
      gera[t,4] = gh + pho*q[t] # Geracao hidro
      gh = gera[t,4]
      A = volumes[t+1] # Atualizando agua para os outros segmentos de custo da agua
      qt = q[t]
      
      if(gera[t,4]>=L){ # Caso a agua supra a demanda
        gera[t,4]=L
        #gera[t,1:3] = 0
        q[t] = min(L/pho,qmax)
        volumes[t+1] = min(y[[t]]+volumes[t]-q[t],vmax)
        cust[t] = max(c(a2$ca*volumes[t+1] + a2$cl,0)) #sum(termicas$ca*gera[t,1:3]) + max(c(a2$ca*volumes[t+1] + a2$cl,0))
        next
      }
    }
    
    if(ode[[t]][k,"nome"] != "H" ){
    }
  }
}
```
  
```{r}
  for (k in 1:10) {
    if(k==2){
      next}
    for (l in 1:5) {
      print(c(k,l))
      if(l ==3){
        if(k==3){
          break
        }
        
      }
    }
  }
```

